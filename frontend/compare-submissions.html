<!DOCTYPE html>
<html>
<head>
    <title>Compare Test vs Real Submissions</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const CryptoJS = window.CryptoJS;

        const firebaseConfig = {
            apiKey: "AIzaSyBYQwkLnzoN7ECF1X0x7F-VWsSqqPwDbPc",
            authDomain: "digital-b6a84.firebaseapp.com",
            projectId: "digital-b6a84",
            storageBucket: "digital-b6a84.firebasestorage.app",
            messagingSenderId: "687546109945",
            appId: "1:687546109945:web:d5ec1d0850792343777728"
        };

        const ENCRYPTION_KEY = 'secure-digital-wallet-2024';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        function decryptData(encryptedData) {
            try {
                const decrypted = CryptoJS.AES.decrypt(encryptedData, ENCRYPTION_KEY);
                const jsonString = decrypted.toString(CryptoJS.enc.Utf8);
                return JSON.parse(jsonString);
            } catch (error) {
                return { error: error.message };
            }
        }

        async function compareSubmissions() {
            try {
                console.log("üìñ Fetching all submissions...");
                const querySnapshot = await getDocs(
                    query(collection(db, "submissions"), orderBy("submittedAt", "desc"))
                );
                
                console.log("‚úÖ Found", querySnapshot.size, "submissions");

                let html = `<h2>üìä Found ${querySnapshot.size} Submission(s)</h2>`;

                if (querySnapshot.size === 0) {
                    html += '<div class="warning">‚ö†Ô∏è No submissions found in database!</div>';
                } else {
                    querySnapshot.forEach((doc, index) => {
                        const data = doc.data();
                        console.log(`Submission ${index + 1}:`, doc.id, data);

                        // Try to decrypt
                        let decryptedData = null;
                        let decryptError = null;
                        
                        if (data.encryptedData) {
                            try {
                                decryptedData = decryptData(data.encryptedData);
                                if (decryptedData.error) {
                                    decryptError = decryptedData.error;
                                    decryptedData = null;
                                }
                            } catch (err) {
                                decryptError = err.message;
                            }
                        } else {
                            decryptError = "No encryptedData field found";
                        }

                        // Determine if this is a test submission
                        const isTest = data.test === true || 
                                      decryptedData?.name === "Test User" ||
                                      decryptedData?.message === "Test submission";

                        html += `
                        <div class="submission ${decryptedData ? 'success' : 'error'}">
                            <div class="header">
                                <h3>Submission ${index + 1} ${isTest ? 'üß™ (TEST)' : 'üë§ (REAL USER)'}</h3>
                                <span class="badge ${decryptedData ? 'badge-success' : 'badge-error'}">
                                    ${decryptedData ? '‚úÖ Decrypted' : '‚ùå Failed'}
                                </span>
                            </div>
                            
                            <div class="details">
                                <strong>Document ID:</strong> ${doc.id}<br>
                                <strong>Submitted At:</strong> ${data.submittedAt || 'N/A'}<br>
                                <strong>Status:</strong> ${data.status || 'N/A'}<br>
                                <strong>Has Encrypted Data:</strong> ${data.encryptedData ? 'Yes' : 'No'}<br>
                                ${data.encryptedData ? `<strong>Encrypted Data Length:</strong> ${data.encryptedData.length} chars<br>` : ''}
                                <strong>All Fields:</strong> ${Object.keys(data).join(', ')}<br>
                            </div>

                            ${decryptedData ? `
                                <div class="decrypted-data">
                                    <strong>‚úÖ Decrypted Data:</strong>
                                    <pre>${JSON.stringify(decryptedData, null, 2)}</pre>
                                    
                                    <div class="analysis">
                                        <strong>Data Analysis:</strong><br>
                                        ‚Ä¢ Has name: ${decryptedData.name ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Has dob: ${decryptedData.dob ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Has address: ${decryptedData.address ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Has username: ${decryptedData.username ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Has id: ${decryptedData.id ? '‚úÖ' : '‚ùå'}<br>
                                        ‚Ä¢ Total fields: ${Object.keys(decryptedData).length}
                                    </div>
                                </div>
                            ` : `
                                <div class="error-data">
                                    <strong>‚ùå Decryption Failed:</strong><br>
                                    ${decryptError}
                                </div>
                            `}
                        </div>`;
                    });

                    // Summary
                    const testCount = Array.from(querySnapshot.docs).filter(doc => {
                        const data = doc.data();
                        if (data.test === true) return true;
                        if (!data.encryptedData) return false;
                        try {
                            const decrypted = decryptData(data.encryptedData);
                            return decrypted.name === "Test User" || decrypted.message === "Test submission";
                        } catch {
                            return false;
                        }
                    }).length;

                    const realCount = querySnapshot.size - testCount;

                    html += `
                    <div class="summary">
                        <h3>üìà Summary</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-number">${querySnapshot.size}</div>
                                <div class="summary-label">Total Submissions</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-number">${testCount}</div>
                                <div class="summary-label">Test Submissions</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-number">${realCount}</div>
                                <div class="summary-label">Real User Submissions</div>
                            </div>
                        </div>
                        
                        ${realCount === 0 ? `
                            <div class="warning" style="margin-top: 20px;">
                                ‚ö†Ô∏è <strong>No real user submissions found!</strong><br>
                                This confirms that real user uploads are not being saved to Firebase.
                            </div>
                        ` : `
                            <div class="success" style="margin-top: 20px;">
                                ‚úÖ <strong>Real user submissions exist!</strong><br>
                                The issue might be with how the admin dashboard retrieves or displays them.
                            </div>
                        `}
                    </div>`;
                }

                document.getElementById('results').innerHTML = html;
            } catch (error) {
                console.error("‚ùå Error:", error);
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        ‚ùå Error: ${error.message}<br><br>
                        ${error.code === 'permission-denied' ? 
                            'üí° This is a permission error. Make sure Firestore security rules are deployed!' : 
                            'Check the console for more details.'}
                    </div>`;
            }
        }

        window.addEventListener('load', () => {
            if (typeof CryptoJS === 'undefined') {
                document.getElementById('results').innerHTML = '<div class="error">‚ùå CryptoJS not loaded!</div>';
                return;
            }
            compareSubmissions();
        });

        window.compareSubmissions = compareSubmissions;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 30px auto;
            padding: 20px;
            background: #f5f7fa;
        }
        h1 { color: #2c3e50; margin-bottom: 10px; }
        h2 { color: #34495e; margin-top: 30px; }
        h3 { color: #555; margin: 0; }
        
        .submission {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        .submission.success { border-left-color: #27ae60; }
        .submission.error { border-left-color: #e74c3c; }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        .badge-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            line-height: 1.8;
        }
        
        .decrypted-data, .error-data {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
        }
        .decrypted-data {
            background: #d4edda;
            border: 1px solid #c3e6cb;
        }
        .error-data {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        pre {
            background: white;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .analysis {
            background: white;
            padding: 15px;
            margin-top: 10px;
            border-radius: 5px;
            line-height: 1.8;
        }
        
        .summary {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .summary-number {
            font-size: 48px;
            font-weight: bold;
            color: #3498db;
        }
        
        .summary-label {
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:hover {
            background: #2980b9;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üîç Submission Comparison Tool</h1>
    
    <div class="info-box">
        <strong>What this tool does:</strong>
        <ul>
            <li>Fetches ALL submissions from Firebase</li>
            <li>Identifies which are test submissions vs real user submissions</li>
            <li>Decrypts and analyzes the data structure</li>
            <li>Helps identify why real submissions might not appear in admin dashboard</li>
        </ul>
    </div>
    
    <button onclick="compareSubmissions()">üîÑ Refresh Analysis</button>
    
    <div id="results">
        <p>Loading...</p>
    </div>
    
    <div class="info-box">
        <strong>üí° What to look for:</strong>
        <ul>
            <li><strong>If "Real User Submissions" = 0:</strong> User uploads are not being saved to Firebase</li>
            <li><strong>If "Real User Submissions" > 0:</strong> Data is being saved, but admin dashboard isn't showing it</li>
            <li><strong>Check data structure:</strong> Compare test vs real submissions - are they identical?</li>
            <li><strong>Check decryption:</strong> If real submissions fail to decrypt, there's a data format issue</li>
        </ul>
    </div>
</body>
</html>