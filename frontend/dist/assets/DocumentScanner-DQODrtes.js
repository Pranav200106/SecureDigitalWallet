import{i as ee,j as e,r as i,B as m,T as x,A as M,C as q,s as te,I as ae}from"./index-CQi3PHFX.js";import{d as L,R as re,a as oe}from"./react-webcam-BH7rRv44.js";import{r as ne,d as se}from"./CheckCircle-DODlBGN0.js";import{d as le}from"./Error-BUZlbj-z.js";import{u as ce}from"./useTheme-BwfxRj1I.js";import{C as Y}from"./Chip-NFilBpqK.js";import{B as _}from"./Button-C5D5G1VZ.js";import"./ownerWindow-CN4f4NkX.js";import"./debounce-Be36O1Ab.js";import"./useControlled-VN5YBWhF.js";var O={},ie=ee;Object.defineProperty(O,"__esModule",{value:!0});var J=O.default=void 0,de=ie(ne()),ue=e;J=O.default=(0,de.default)((0,ue.jsx)("path",{d:"M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M14 13v4h-4v-4H7l5-5 5 5z"}),"CloudUpload");const k="http://localhost:5000";class he{async extractFromFile(r,t=!0){try{const o=new FormData;o.append("file",r),o.append("enhance",t.toString());const c=await fetch(`${k}/extract-upload`,{method:"POST",body:o});if(!c.ok){const b=await c.json().catch(()=>({}));throw new Error(b.error_message||`HTTP error! status: ${c.status}`)}const h=await c.json();if(h.status==="error")throw new Error(h.error_message||"Extraction failed");return h}catch(o){throw console.error("OCR API Error:",o),new Error(`Failed to extract document data: ${o.message}`)}}async extractFromDataUrl(r,t=!0){try{const o=await this.dataUrlToBlob(r),c=new File([o],"captured-image.jpg",{type:"image/jpeg"});return await this.extractFromFile(c,t)}catch(o){throw console.error("OCR API Error:",o),new Error(`Failed to extract from captured image: ${o.message}`)}}async extractFromPath(r,t=!0){try{const o=await fetch(`${k}/extract-by-path`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({image_path:r,enhance:t})});if(!o.ok){const h=await o.json().catch(()=>({}));throw new Error(h.error_message||`HTTP error! status: ${o.status}`)}const c=await o.json();if(c.status==="error")throw new Error(c.error_message||"Extraction failed");return c}catch(o){throw console.error("OCR API Error:",o),new Error(`Failed to extract document data: ${o.message}`)}}async healthCheck(){try{return await(await fetch(`${k}/health`)).json()}catch(r){throw console.error("Health check failed:",r),new Error("API is not available")}}async dataUrlToBlob(r){return await(await fetch(r)).blob()}formatExtractedData(r){if(!r||r.status!=="success")return null;const t=r.extracted_data||{};return{name:t.name||"Not found",dob:t.dob||"Not found",age:t.dob?this.calculateAge(t.dob):"Not found",gender:t.gender||"Not found",address:t.address||"Not found",documentType:t.document_type||"unknown",aadharNumber:t.aadhar_number||null,panNumber:t.pan_number||null,dlNumber:t.dl_number||null,bloodGroup:t.blood_group||null,fatherName:t.father_name||null,pinCode:t.pin_code||null,state:t.state||null,issueDate:t.issue_date||null,validity:t.validity||null}}calculateAge(r){if(!r||r==="Not found")return null;try{const t=r.split(/[\/\-]/);if(t.length!==3)return null;const o=parseInt(t[0],10),c=parseInt(t[1],10)-1,h=parseInt(t[2],10);if(isNaN(o)||isNaN(c)||isNaN(h))return null;const b=new Date(h,c,o),y=new Date;let g=y.getFullYear()-b.getFullYear();const F=y.getMonth()-b.getMonth();return(F<0||F===0&&y.getDate()<b.getDate())&&g--,g}catch(t){return console.error("Error calculating age:",t),null}}}const N=new he,me=te("input")({clipPath:"inset(50%)",height:1,overflow:"hidden",position:"absolute",bottom:0,left:0,whiteSpace:"nowrap",width:1}),De=({onFaceScanned:C,modelsLoaded:r,loadingError:t,hashVerificationError:o})=>{const[c,h]=i.useState(null),[b,y]=i.useState(null),g=ce(),[F,S]=i.useState(null),[T,R]=i.useState(null),[j,w]=i.useState(!1),[D,u]=i.useState(null),[X,P]=i.useState(!1),[U,$]=i.useState(!1),[a,v]=i.useState(null),[p,B]=i.useState(null),A=i.useRef(null),z=i.useRef(null);i.useEffect(()=>{K()},[]),i.useEffect(()=>{t||o?u(t||o):r&&D&&u(null)},[r,t,o,D]);const K=async()=>{try{const n=await N.healthCheck();B(n),console.log("API Health:",n)}catch(n){console.error("API health check failed:",n),B({status:"unhealthy",error:n.message})}},Q=async n=>{$(!0),u(null);try{console.log("Starting OCR extraction via API...");let s;if(n instanceof File)s=await N.extractFromFile(n,!0);else if(typeof n=="string")s=await N.extractFromDataUrl(n,!0);else throw new Error("Invalid source type for OCR");console.log("API Response:",s);const l=N.formatExtractedData(s);if(!l)throw new Error("Failed to format extracted data");return v(l),console.log("Formatted Extracted Data:",l),l}catch(s){return console.error("OCR API Error:",s),u(`OCR Failed: ${s.message}`),null}finally{$(!1)}},Z=async n=>{const s=n.target.files[0];if(s){w(!0),u(null),v(null),y(s),h(URL.createObjectURL(s)),P(!1);const l=new Image;l.src=URL.createObjectURL(s),l.onload=async()=>{z.current=l,await W(l,s),w(!1)},l.onerror=()=>{u("Failed to load image. Please try again."),w(!1)}}},V=async()=>{if(A.current){w(!0),u(null),v(null);const n=A.current.getScreenshot();h(n),P(!1);const s=new Image;s.src=n,s.onload=async()=>{z.current=s,await W(s,n),w(!1)},s.onerror=()=>{u("Failed to capture image. Please try again."),w(!1)}}},W=async(n,s)=>{if(!r){u("Face detection models not loaded yet. Please wait.");return}try{console.log("Detecting face...");const l=await oe(n).withFaceLandmarks().withFaceDescriptor();if(!l){u("No face detected in the document. Please try a different image."),S(null),R(null),v(null);return}console.log("Face detected successfully"),S(l.descriptor);const f=l.detection.box,I=document.createElement("canvas");I.width=f.width,I.height=f.height,I.getContext("2d").drawImage(n,f.x,f.y,f.width,f.height,0,0,f.width,f.height);const H=I.toDataURL("image/jpeg");R(H),console.log("Extracting document data via API...");const E=await Q(s);E&&(console.log("DocumentScanner: OCR Data prepared for onFaceScanned:",E),u(null),C(l.descriptor,H,E))}catch(l){console.error("Error scanning document for face:",l),u(`Scanning error: ${l.message}`)}},G=()=>{P(n=>!n),h(null),y(null),S(null),R(null),v(null),u(null)};return e.jsxs(m,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"100vh",backgroundColor:g.palette.background.default,padding:"20px",gap:3},children:[e.jsx(x,{variant:"h4",sx:{color:"#333",fontWeight:"bold",mb:2},children:"Upload or Capture Government ID"}),p&&e.jsx(Y,{label:`API: ${p.status==="healthy"?"Online":"Offline"}`,color:p.status==="healthy"?"success":"error",size:"small",sx:{mb:1}}),(t||o)&&e.jsx(M,{severity:"error",sx:{width:"100%",maxWidth:"500px",mb:2},children:t||o}),!r&&!t&&e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1,color:"text.secondary"},children:[e.jsx(q,{size:20}),e.jsx(x,{variant:"body1",children:"Loading face detection models..."})]}),D&&e.jsx(M,{severity:"error",sx:{width:"100%",maxWidth:"500px",mb:2},icon:e.jsx(le,{}),children:D}),e.jsxs(m,{sx:{display:"flex",flexDirection:"column",gap:2,backgroundColor:g.palette.background.paper,boxShadow:3,borderRadius:"12px",padding:"30px",width:"100%",maxWidth:"500px",alignItems:"center"},children:[X?e.jsxs(m,{sx:{position:"relative",width:"100%",height:"300px",borderRadius:"12px",overflow:"hidden",border:"2px solid #ddd"},children:[e.jsx(re,{ref:A,audio:!1,screenshotFormat:"image/jpeg",videoConstraints:{facingMode:"environment"},style:{width:"100%",height:"100%",objectFit:"cover"}}),e.jsx(ae,{onClick:V,disabled:j||!r,sx:{position:"absolute",bottom:10,left:"50%",transform:"translateX(-50%)",backgroundColor:"rgba(0,0,0,0.5)",color:"white","&:hover":{backgroundColor:"rgba(0,0,0,0.7)"}},children:e.jsx(L,{sx:{fontSize:40}})}),e.jsx(_,{variant:"text",onClick:G,sx:{position:"absolute",top:10,right:10,color:"white",backgroundColor:"rgba(0,0,0,0.5)"},children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(_,{component:"label",variant:"contained",startIcon:e.jsx(J,{}),sx:{width:"100%",padding:"12px",fontSize:"16px",borderRadius:"8px"},disabled:!r||j||(p==null?void 0:p.status)!=="healthy",children:["Upload Document Image",e.jsx(me,{type:"file",accept:"image/*",onChange:Z})]}),e.jsx(x,{variant:"body2",sx:{color:"text.secondary",my:1},children:"OR"}),e.jsx(_,{variant:"outlined",startIcon:e.jsx(L,{}),onClick:G,sx:{width:"100%",padding:"12px",fontSize:"16px",borderRadius:"8px"},disabled:!r||j||(p==null?void 0:p.status)!=="healthy",children:"Capture Document with Camera"})]}),c&&e.jsxs(m,{sx:{mt:2,textAlign:"center"},children:[e.jsx(x,{variant:"h6",sx:{mb:1},children:"Preview:"}),e.jsx("img",{src:c,alt:"Document Preview",style:{maxWidth:"100%",maxHeight:"250px",borderRadius:"8px"}})]}),(j||U)&&e.jsxs(m,{sx:{display:"flex",alignItems:"center",gap:1,mt:2},children:[e.jsx(q,{size:24}),e.jsx(x,{variant:"body1",children:U?"Extracting text via AI...":"Scanning for face..."})]}),F&&!j&&e.jsxs(m,{sx:{mt:2,display:"flex",alignItems:"center",gap:1,color:"green"},children:[e.jsx(se,{}),e.jsx(x,{variant:"body1",children:"Face Scanned Successfully!"})]}),T&&e.jsxs(m,{sx:{mt:2,textAlign:"center"},children:[e.jsx(x,{variant:"h6",sx:{mb:1},children:"Extracted Face:"}),e.jsx("img",{src:T,alt:"Extracted Face",style:{width:"150px",height:"150px",borderRadius:"50%",border:"2px solid #006FB9",objectFit:"cover"}})]}),a&&e.jsxs(m,{sx:{mt:2,width:"100%",backgroundColor:g.palette.mode==="dark"?"rgba(255, 255, 255, 0.05)":"#f8f9fa",padding:2,borderRadius:"8px",border:`1px solid ${g.palette.mode==="dark"?"rgba(255, 255, 255, 0.1)":"#e9ecef"}`},children:[e.jsx(x,{variant:"h6",sx:{mb:2,color:"#006FB9",fontWeight:"bold"},children:"Extracted Information"}),a.documentType&&a.documentType!=="unknown"&&e.jsx(Y,{label:a.documentType.toUpperCase().replace("_"," "),color:"primary",size:"small",sx:{mb:2}}),e.jsxs(m,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:[e.jsx(d,{label:"Name",value:a.name}),e.jsx(d,{label:"Date of Birth",value:a.dob}),e.jsx(d,{label:"Age",value:a.age}),e.jsx(d,{label:"Gender",value:a.gender}),a.fatherName&&a.fatherName!=="Not found"&&e.jsx(d,{label:"Father's Name",value:a.fatherName}),a.bloodGroup&&a.bloodGroup!=="Not found"&&e.jsx(d,{label:"Blood Group",value:a.bloodGroup}),e.jsx(d,{label:"Address",value:a.address,multiline:!0}),a.pinCode&&a.pinCode!=="Not found"&&e.jsx(d,{label:"PIN Code",value:a.pinCode}),a.state&&a.state!=="Not found"&&e.jsx(d,{label:"State",value:a.state}),a.aadharNumber&&e.jsx(d,{label:"Aadhaar Number",value:a.aadharNumber}),a.panNumber&&e.jsx(d,{label:"PAN Number",value:a.panNumber}),a.dlNumber&&e.jsx(d,{label:"DL Number",value:a.dlNumber}),a.issueDate&&a.issueDate!=="Not found"&&e.jsx(d,{label:"Issue Date",value:a.issueDate}),a.validity&&a.validity!=="Not found"&&e.jsx(d,{label:"Validity",value:a.validity})]})]})]})]})},d=({label:C,value:r,multiline:t=!1})=>e.jsxs(m,{children:[e.jsxs(x,{variant:"body2",component:"span",sx:{fontWeight:"bold",color:"#555"},children:[C,":"," "]}),e.jsx(x,{variant:"body2",component:"span",sx:{color:r==="Not found"?"red":"#333",fontStyle:r==="Not found"?"italic":"normal",wordBreak:t?"break-word":"normal"},children:r})]});export{De as default};
